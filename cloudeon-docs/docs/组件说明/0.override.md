# 部署总览

## 总体部署说明

组件主要有2类：系统组件和业务组件。
其中系统组件通常是CloudEon某些功能的基础，业务组件则是用户业务所需的组件。
因此，应先根据功能需求安装部分/全部系统组件，再根据业务需求安装业务组件。

例如，作为快速体验，可直接安装 Zookeeper 组件。
而如果想要使用指标采集、监控浏览、告警通知功能，则需要部署KubePrometheus组件，及其依赖的HelmController组件。
而如果想要使用组件日志采集分析功能，则需要部署Filebeat、ElasticSearch组件，及其依赖的OpenKruise组件。

注意：不管是部署哪些组件，Global组件都是必需的，不过Global只提供通用配置，不进行实际部署。

## 部署建议

1. 第一次部署时建议组件逐个部署，如果有问题方便排错
2. 如果某部署步骤出错，优先查看对应步骤的日志，大部分的报错信息都会体现在日志里面，
   如果该步骤是对应k8s资源的apply，通常还会捕获到对应容器的日志输出。如果没有得到有用信息，再使用k8s相关命令或工具（如Lens）进行调试排错。
3. 某组件部署时如果超时，通常是对应k8s资源状态不对导致，如 zookeeper实际运行失败，导致其pod检活不通过。这个时候应`停止`
   该任务，查看具体原因并处理。如果是外部原因，如端口占用、系统hosts配置错误等，处理后删除pod使其强制重启，确定其状态正常，再在任务界面`重试`
   即可，`重试`
   会从上次中断的任务处开始执行，检测到pod检活正常后则进入下一步。如果是组件自身原因，如配置错误，则对组件配置文件修正，然后`重启`
   该组件即可。

## 持久化存储说明

控制组件持久化挂载的有2个参数：Global组件的`global.persistence.basePath`参数（只能写一个路径）和对应组件的`data.path.list`
参数（支持多路径，逗号分隔。如果该组件不支持多路径，就算写多个也只有第一个路径生效）。

各角色会挂载使用`data.path.list`或`global.persistence.basePath`的角色名子路径

默认情况下`data.path.list`为空，此时会使用global.persistence.basePath作为根路径。

该功能的实现原理和具体挂载规则参考开发文档

## 当前支持组件版本

| 序号 | 名称                    | 类型    | k8s资源类型    | 版本     | 描述                                                                                                              | 依赖组件                     |
|----|-----------------------|-------|------------|--------|-----------------------------------------------------------------------------------------------------------------|--------------------------|
| 1  | **📁 Global**         | 系统，必需 | 无          | 无      | CloudEon全局配置组件，该组件的配置会影响其他组件，是所有其他组件的基础                                                                         |                          |
| 2  | **HelmController**    | 系统    | Deployment | 0.15.4 | Helm控制器，带来CloudEon对于HelmChart资源的支持                                                                              |                          |
| 3  | **🚨 KubePrometheus** | 系统    | HelmChart  | 55.0.0 | kube-prometheus套件，含Prometheus、Grafana、AlertManager等组件，是CloudEon指标采集、监控告警等功能的基础，也可对接外部已有的kube-prometheus来取代部署此组件 | HelmController           |
| 4  | **OpenKruise**        | 系统    | HelmChart  | 1.5.1  | Kubernetes扩展套件，带来CloudEon对于SidecarSet资源的支持                                                                      | HelmController           |
| 5  | **🧿 ElasticSearch**  | 系统/业务 | Deployment | 7.16.3 | 全文检索服务，是CloudEon组件日志分析功能的基础                                                                                     |                          |
| 6  | **Filebeat**          | 系统    | SidecarSet | 7.16.3 | 日志采集工具，是CloudEon组件日志分析功能的基础                                                                                     | OpenKruise,ElasticSearch |
| 7  | **🦜 ZooKeeper**      | 业务    | Deployment | 3.5.9  | 分布式协调服务与一致性解决方案                                                                                                 |                          |
| 8  | **📁 HDFS**           | 业务    | Deployment | 3.3.4  | 分布式高可靠性文件系统                                                                                                     | ZooKeeper                |
| 9  | **🚀 YARN**           | 业务    | Deployment | 3.3.4  | 集群资源管理与调度平台                                                                                                     | HDFS                     |
| 10 | **🐿️ Flink**         | 业务    | Deployment | 1.15.4 | 实时计算引擎                                                                                                          | YARN                     |

